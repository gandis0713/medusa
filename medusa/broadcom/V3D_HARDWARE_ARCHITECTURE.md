# V3D 7.1 GPU 하드웨어 아키텍처 (Raspberry Pi 5)

## 목차
1. [전체 시스템 구성도](#전체-시스템-구성도)
2. [하드웨어 컴포넌트 상세](#하드웨어-컴포넌트-상세)
3. [메모리 계층 구조](#메모리-계층-구조)
4. [데이터 흐름](#데이터-흐름)
5. [성능 특성](#성능-특성)

---

## 전체 시스템 구성도

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                         Raspberry Pi 5 (BCM2712 SoC)                        │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  ┌───────────────────────────────────────────────────────────────────┐     │
│  │                      CPU (ARM Cortex-A76 × 4)                     │     │
│  │                                                                   │     │
│  │  ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌──────────┐         │     │
│  │  │ Core 0   │  │ Core 1   │  │ Core 2   │  │ Core 3   │         │     │
│  │  │  L1I/L1D │  │  L1I/L1D │  │  L1I/L1D │  │  L1I/L1D │         │     │
│  │  └────┬─────┘  └────┬─────┘  └────┬─────┘  └────┬─────┘         │     │
│  │       └─────────────┴─────────────┴─────────────┘               │     │
│  │                          │                                       │     │
│  │                    ┌─────▼──────┐                                │     │
│  │                    │  L2 Cache  │                                │     │
│  │                    │  (512 KB)  │                                │     │
│  │                    └─────┬──────┘                                │     │
│  └──────────────────────────┼───────────────────────────────────────┘     │
│                             │                                             │
│  ═══════════════════════════╪═════════════════════════════════════════    │
│                             │                                             │
│                        ┌────▼────┐                                        │
│                        │   AXI   │  ◄── System Interconnect              │
│                        │   Bus   │      (AMBA AXI4)                       │
│                        └────┬────┘                                        │
│                             │                                             │
│         ┌───────────────────┼───────────────────┐                         │
│         │                   │                   │                         │
│    ┌────▼─────┐       ┌────▼────┐        ┌────▼────┐                     │
│    │  DRAM    │       │   V3D   │        │  Other  │                     │
│    │          │       │   GPU   │        │   I/O   │                     │
│    │ 4/8 GB   │       │  7.1.x  │        │ (PCIe,  │                     │
│    │ LPDDR4X  │       │         │        │  USB,   │                     │
│    │          │       │         │        │  etc)   │                     │
│    └──────────┘       └────┬────┘        └─────────┘                     │
│                            │                                              │
│                     [상세 구조 ▼]                                          │
└─────────────────────────────┼──────────────────────────────────────────────┘
                              │
```

---

## V3D 7.1 GPU 내부 아키텍처

### 1. 최상위 구조

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                            V3D 7.1 GPU Core                                 │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                         V3D Hub (제어 및 공유 자원)                  │   │
│  │                                                                     │   │
│  │  ┌──────────────┐  ┌──────────────┐  ┌──────────────────────┐      │   │
│  │  │     CLE      │  │     MMU      │  │    L2 Cache (L2T)    │      │   │
│  │  │ (Control List│  │  (Memory     │  │                      │      │   │
│  │  │  Executor)   │  │  Management  │  │    ~128 KB           │      │   │
│  │  │              │  │   Unit)      │  │    256-byte lines    │      │   │
│  │  │  • Binning   │  │              │  │    ~20 cycle latency │      │   │
│  │  │  • Rendering │  │  • Address   │  │                      │      │   │
│  │  │  • Compute   │  │    translation│  │  • Write-back       │      │   │
│  │  └──────┬───────┘  └──────┬───────┘  └──────────┬───────────┘      │   │
│  │         │                 │                     │                  │   │
│  └─────────┼─────────────────┼─────────────────────┼──────────────────┘   │
│            │                 │                     │                      │
│  ══════════╪═════════════════╪═════════════════════╪══════════════════    │
│            │                 │                     │                      │
│  ┌─────────▼─────────────────▼─────────────────────▼──────────────────┐   │
│  │                    AXI Interface (메모리 버스)                       │   │
│  │                                                                     │   │
│  │  Performance Counters:                                              │   │
│  │  • AXI Read/Write Transactions                                      │   │
│  │  • AXI Read/Write Bytes                                             │   │
│  │  • AXI Stalls (Read/Write)                                          │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│            │                                                                │
│            ▼                                                                │
│     [System DRAM via AXI Bus]                                              │
│                                                                             │
│  ══════════════════════════════════════════════════════════════════════    │
│                                                                             │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                   Rendering Pipeline (3 Slices)                     │   │
│  │                                                                     │   │
│  │  ┌───────────────────────────────────────────────────────────┐      │   │
│  │  │                     Slice 0 (NSLC=0)                      │      │   │
│  │  ├───────────────────────────────────────────────────────────┤      │   │
│  │  │                                                           │      │   │
│  │  │  ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌──────────┐  │      │   │
│  │  │  │  QPU 0   │  │  QPU 1   │  │  QPU 2   │  │  QPU 3   │  │      │   │
│  │  │  └────┬─────┘  └────┬─────┘  └────┬─────┘  └────┬─────┘  │      │   │
│  │  │       │             │             │             │         │      │   │
│  │  │       └─────────────┴─────────────┴─────────────┘         │      │   │
│  │  │                          │                                │      │   │
│  │  │                    ┌─────▼──────┐                         │      │   │
│  │  │                    │    TMU     │                         │      │   │
│  │  │                    │  (공유)     │                         │      │   │
│  │  │                    │            │                         │      │   │
│  │  │                    │  L1 Cache  │                         │      │   │
│  │  │                    │  (~16 KB)  │                         │      │   │
│  │  │                    └─────┬──────┘                         │      │   │
│  │  │                          │                                │      │   │
│  │  └──────────────────────────┼────────────────────────────────┘      │   │
│  │                             ▼                                       │   │
│  │                        [L2 Cache]                                   │   │
│  │                                                                     │   │
│  │  ┌───────────────────────────────────────────────────────────┐      │   │
│  │  │                     Slice 1 (NSLC=1)                      │      │   │
│  │  ├───────────────────────────────────────────────────────────┤      │   │
│  │  │  ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌──────────┐  │      │   │
│  │  │  │  QPU 4   │  │  QPU 5   │  │  QPU 6   │  │  QPU 7   │  │      │   │
│  │  │  └────┬─────┘  └────┬─────┘  └────┬─────┘  └────┬─────┘  │      │   │
│  │  │       └─────────────┴─────────────┴─────────────┘         │      │   │
│  │  │                          │                                │      │   │
│  │  │                    ┌─────▼──────┐                         │      │   │
│  │  │                    │    TMU     │                         │      │   │
│  │  │                    │  (공유)     │                         │      │   │
│  │  │                    │  L1 Cache  │                         │      │   │
│  │  │                    └─────┬──────┘                         │      │   │
│  │  │                          │                                │      │   │
│  │  └──────────────────────────┼────────────────────────────────┘      │   │
│  │                             ▼                                       │   │
│  │                        [L2 Cache]                                   │   │
│  │                                                                     │   │
│  │  ┌───────────────────────────────────────────────────────────┐      │   │
│  │  │                     Slice 2 (NSLC=2)                      │      │   │
│  │  ├───────────────────────────────────────────────────────────┤      │   │
│  │  │  ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌──────────┐  │      │   │
│  │  │  │  QPU 8   │  │  QPU 9   │  │  QPU 10  │  │  QPU 11  │  │      │   │
│  │  │  └────┬─────┘  └────┬─────┘  └────┬─────┘  └────┬─────┘  │      │   │
│  │  │       └─────────────┴─────────────┴─────────────┘         │      │   │
│  │  │                          │                                │      │   │
│  │  │                    ┌─────▼──────┐                         │      │   │
│  │  │                    │    TMU     │                         │      │   │
│  │  │                    │  (공유)     │                         │      │   │
│  │  │                    │  L1 Cache  │                         │      │   │
│  │  │                    └─────┬──────┘                         │      │   │
│  │  │                          │                                │      │   │
│  │  └──────────────────────────┼────────────────────────────────┘      │   │
│  │                             ▼                                       │   │
│  │                        [L2 Cache]                                   │   │
│  │                                                                     │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                         기타 Fixed-Function Units                    │   │
│  │                                                                     │   │
│  │  • TFU (Texture Formatting Unit): 텍스처 포맷 변환                   │   │
│  │  • TLB (Tile Buffer): 타일 렌더링 버퍼 (16 KB color + 16 KB depth)  │   │
│  │  • PTB (Primitive Tile Binner): 프리미티브 타일링                    │   │
│  │  • PSE (Primitive Setup Engine): 프리미티브 셋업                     │   │
│  │  • VPM (Vertex Pipe Memory): 버텍스 파이프 메모리                    │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘

주요 수치 (Raspberry Pi 5 기준):
• NSLC (Number of Slices): 3
• QUPS (QPUs per Slice): 4
• 총 QPU 개수: 12 (NSLC × QUPS = 3 × 4)
• QPU당 쓰레드 수: 16 (16-way SIMD)
• 총 동시 실행 가능 쓰레드: 192 (12 QPU × 16 threads)
```

---

## 하드웨어 컴포넌트 상세

### 1. QPU (Quad Processing Unit)

```
┌─────────────────────────────────────────────────────────────────────┐
│                         QPU (Single Unit)                           │
├─────────────────────────────────────────────────────────────────────┤
│                                                                     │
│  ┌───────────────────────────────────────────────────────────────┐  │
│  │              Execution Context (16 Threads)                   │  │
│  │                                                               │  │
│  │  Thread:  0   1   2   3   4   5   6   7   8  ...  14  15     │  │
│  │  Status: [A] [A] [W] [A] [W] [A] [A] [W] [A] ... [A] [W]     │  │
│  │           A=Active, W=Waiting                                 │  │
│  └───────────────────────────────────────────────────────────────┘  │
│                                                                     │
│  ┌───────────────────────────────────────────────────────────────┐  │
│  │                    Instruction Fetch                          │  │
│  │  ┌──────────────┐         ┌──────────────┐                    │  │
│  │  │ Instruction  │ ──────► │ Instruction  │                    │  │
│  │  │   Cache      │         │   Decoder    │                    │  │
│  │  │   (I-Cache)  │         │              │                    │  │
│  │  └──────────────┘         └──────┬───────┘                    │  │
│  └─────────────────────────────────┼────────────────────────────┘  │
│                                    │                               │
│  ┌─────────────────────────────────▼────────────────────────────┐  │
│  │                   Register Files                             │  │
│  │                                                               │  │
│  │  ┌──────────────────┐    ┌──────────────────┐                │  │
│  │  │  Physical RF     │    │  Accumulators    │                │  │
│  │  │  (rf0 ~ rf63)    │    │  (r0 ~ r5)       │                │  │
│  │  │                  │    │  [V3D 4.x only]  │                │  │
│  │  │  64 × 32-bit     │    │  6 × 32-bit      │                │  │
│  │  │  per thread      │    │  per thread      │                │  │
│  │  └──────────────────┘    └──────────────────┘                │  │
│  │                                                               │  │
│  │  ┌──────────────────┐    ┌──────────────────┐                │  │
│  │  │   Uniform FIFO   │    │  Special Regs    │                │  │
│  │  │  (read-only)     │    │  (eidx, tidx,    │                │  │
│  │  │                  │    │   elem_num, etc) │                │  │
│  │  └──────────────────┘    └──────────────────┘                │  │
│  └───────────────────────────────────────────────────────────────┘  │
│                                    │                               │
│  ┌─────────────────────────────────▼────────────────────────────┐  │
│  │                   Execution Units (SIMD)                     │  │
│  │                                                               │  │
│  │  ┌─────────────────────────────────────────────────────────┐  │  │
│  │  │              ADD ALU (Integer/Float)                    │  │  │
│  │  │                                                         │  │  │
│  │  │  Operations:                                            │  │  │
│  │  │  • Integer: add, sub, min, max, shl, shr, and, or, xor │  │  │
│  │  │  • Float: fadd, fsub, fmin, fmax                       │  │  │
│  │  │  • Conversion: ftoi, itof                              │  │  │
│  │  │  • Special: v8adds, v8subs (packed 8-bit)              │  │  │
│  │  │                                                         │  │  │
│  │  │  16-way SIMD (모든 16개 쓰레드 동시 실행)                 │  │  │
│  │  └─────────────────────────────────────────────────────────┘  │  │
│  │                                                               │  │
│  │  ┌─────────────────────────────────────────────────────────┐  │  │
│  │  │              MUL ALU (Integer/Float)                    │  │  │
│  │  │                                                         │  │  │
│  │  │  Operations:                                            │  │  │
│  │  │  • Integer: mul24                                       │  │  │
│  │  │  • Float: fmul                                         │  │  │
│  │  │  • Special: v8min, v8max, v8muld (packed 8-bit)        │  │  │
│  │  │                                                         │  │  │
│  │  │  16-way SIMD (모든 16개 쓰레드 동시 실행)                 │  │  │
│  │  └─────────────────────────────────────────────────────────┘  │  │
│  │                                                               │  │
│  │  • ADD와 MUL은 동시에 실행 가능 (Dual Issue)                   │  │
│  │  • 각 명령어는 8 bytes (64-bit)                               │  │
│  └───────────────────────────────────────────────────────────────┘  │
│                                    │                               │
│  ┌─────────────────────────────────▼────────────────────────────┐  │
│  │                   Memory Access Units                        │  │
│  │                                                               │  │
│  │  ┌────────────────┐  ┌────────────────┐  ┌────────────────┐  │  │
│  │  │      TMU       │  │      VPM       │  │   Uniform      │  │  │
│  │  │   (Texture     │  │  (Vertex Pipe  │  │    FIFO        │  │  │
│  │  │    Memory)     │  │    Memory)     │  │                │  │  │
│  │  │                │  │                │  │  Sequential    │  │  │
│  │  │  • TMUA write  │  │  • VPM read    │  │  read-only     │  │  │
│  │  │  • TMUD write  │  │  • VPM write   │  │                │  │  │
│  │  │  • ldtmu read  │  │                │  │  ldunif/       │  │  │
│  │  │                │  │                │  │  ldunifrf      │  │  │
│  │  └────────┬───────┘  └────────────────┘  └────────────────┘  │  │
│  │           │                                                   │  │
│  │           ▼                                                   │  │
│  │      [TMU Unit]  ◄─ Slice 내 4개 QPU가 공유                    │  │
│  └───────────────────────────────────────────────────────────────┘  │
│                                                                     │
│  ┌───────────────────────────────────────────────────────────────┐  │
│  │                   Control Flow                                │  │
│  │                                                               │  │
│  │  • Branch: b (unconditional)                                 │  │
│  │  • Thread Switch: thrsw (cooperative multithreading)         │  │
│  │  • Barriers: barrierid, syncb                                │  │
│  │  • Program End: thrend                                       │  │
│  └───────────────────────────────────────────────────────────────┘  │
│                                                                     │
└─────────────────────────────────────────────────────────────────────┘

핵심 특징:
• 16-way SIMD: 단일 명령어로 16개 데이터 동시 처리
• Dual Issue: ADD + MUL 동시 실행 (최대 2 ops/cycle)
• Cooperative Multithreading: thrsw로 명시적 쓰레드 전환
• Latency Hiding: 메모리 지연을 다른 쓰레드 실행으로 숨김
```

### 2. TMU (Texture Memory Unit)

```
┌─────────────────────────────────────────────────────────────────────┐
│                 TMU (Slice당 1개, 4개 QPU 공유)                      │
├─────────────────────────────────────────────────────────────────────┤
│                                                                     │
│  ┌───────────────────────────────────────────────────────────────┐  │
│  │                    TMU Request Queue                          │  │
│  │                                                               │  │
│  │  QPU 0 ──┐                                                    │  │
│  │          ├──►  ┌──────────────────────────────────┐           │  │
│  │  QPU 1 ──┤    │   Request FIFO (최대 16 entries)  │           │  │
│  │          │    │                                  │           │  │
│  │  QPU 2 ──┤    │  Entry: {addr, op, thread_id}    │           │  │
│  │          │    └──────────────┬───────────────────┘           │  │
│  │  QPU 3 ──┘                   │                               │  │
│  │                              │                               │  │
│  │  • 요청은 FIFO 순서로 처리                                      │  │
│  │  • Scoreboard 대기: ldtmu 전까지 최대 16개 대기                  │  │
│  └──────────────────────────────┼───────────────────────────────┘  │
│                                 │                                  │
│  ┌──────────────────────────────▼───────────────────────────────┐  │
│  │                   TMU Operations                             │  │
│  │                                                               │  │
│  │  1. Regular Memory Access                                    │  │
│  │     • V3D_TMU_OP_REGULAR (15): 일반 메모리 읽기/쓰기             │  │
│  │                                                               │  │
│  │  2. Atomic Operations (with cache control)                   │  │
│  │     • V3D_TMU_OP_WRITE_ADD_READ_PREFETCH (0)                 │  │
│  │       - Atomic add + 인접 주소 prefetch                        │  │
│  │     • V3D_TMU_OP_WRITE_XCHG_READ_FLUSH (2)                   │  │
│  │       - Atomic exchange + L1 cache line flush                │  │
│  │     • V3D_TMU_OP_WRITE_UMIN_FULL_L1_CLEAR (4)                │  │
│  │       - Atomic unsigned min + L1 전체 invalidate              │  │
│  │     • V3D_TMU_OP_WRITE_OR_READ_FLUSH (6)                     │  │
│  │       - Atomic OR + cache line flush                         │  │
│  │                                                               │  │
│  │  3. Texture Sampling                                         │  │
│  │     • Filtering: bilinear, trilinear                         │  │
│  │     • Mipmapping: automatic LOD calculation                  │  │
│  │     • Texture formats: RGBA, compressed (BSTC, ETC, ASTC)    │  │
│  └───────────────────────────────────────────────────────────────┘  │
│                                 │                                  │
│  ┌──────────────────────────────▼───────────────────────────────┐  │
│  │                    L1 Texture Cache                          │  │
│  │                                                               │  │
│  │  크기: ~16 KB (Slice당)                                        │  │
│  │  Cache Line: 256 bytes                                       │  │
│  │  Latency: ~5 cycles (hit)                                    │  │
│  │  정책: Write-through (쓰기는 L2로 즉시 전달)                     │  │
│  │                                                               │  │
│  │  ┌────────────────────────────────────────┐                  │  │
│  │  │  Cache Line 0 (256 bytes)              │                  │  │
│  │  ├────────────────────────────────────────┤                  │  │
│  │  │  Cache Line 1 (256 bytes)              │                  │  │
│  │  ├────────────────────────────────────────┤                  │  │
│  │  │           ...                          │                  │  │
│  │  ├────────────────────────────────────────┤                  │  │
│  │  │  Cache Line N (256 bytes)              │                  │  │
│  │  └────────────────────────────────────────┘                  │  │
│  │                                                               │  │
│  │  제어 연산:                                                     │  │
│  │  • Flush: 특정 cache line을 L2로 writeback                     │  │
│  │  • Clear: L1 전체 또는 일부 invalidate                         │  │
│  │  • Prefetch: 인접 주소를 L1으로 미리 로드                        │  │
│  └───────────────────────────────────────────────────────────────┘  │
│                                 │                                  │
│                                 ▼                                  │
│                         [L2 Cache (L2T)]                           │
│                                                                     │
└─────────────────────────────────────────────────────────────────────┘

TMU 사용 패턴:
1. TMUA = address       // 주소 설정 (operation 포함)
2. TMUD = data          // 데이터 쓰기 (write 연산인 경우)
3. TMUWT                // 요청 제출 및 대기
4. ldtmu → rf0          // 결과 읽기 (read 연산인 경우)
```

### 3. 캐시 계층 구조

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                         V3D 7.1 Memory Hierarchy                            │
└─────────────────────────────────────────────────────────────────────────────┘

                                QPU Registers
                                (rf0 ~ rf63)
                                   │
                                   │ Immediate access
                                   │
        ┌──────────────────────────┴──────────────────────────┐
        │                                                      │
        │                                                      │
   ┌────▼─────┐                                          ┌────▼─────┐
   │ Uniform  │                                          │   TMU    │
   │  FIFO    │                                          │ L1 Cache │
   │          │                                          │          │
   │ Read-only│                                          │  ~16 KB  │
   │ Per-QPU  │                                          │ 256-byte │
   │          │                                          │  lines   │
   └────┬─────┘                                          └────┬─────┘
        │                                                     │
        │ (loaded at shader start)                           │ ~5 cycles
        │                                                     │
        ▼                                                     ▼
   [System Memory]                               ┌───────────────────────┐
                                                 │    L2 Cache (L2T)     │
                                                 │                       │
                                                 │   Size: ~128 KB       │
                                                 │   Line: 256 bytes     │
                                                 │   Latency: ~20 cycles │
                                                 │                       │
                                                 │   Policy:             │
                                                 │   • Write-back        │
                                                 │   • Shared by all     │
                                                 │     3 Slices          │
                                                 │                       │
                                                 │   Clients:            │
                                                 │   • TMU (texture)     │
                                                 │   • CLE (commands)    │
                                                 │   • VCD (varyings)    │
                                                 │   • TLB (tile buffer) │
                                                 │   • PTB (primitives)  │
                                                 └───────────┬───────────┘
                                                             │
                                                             │ ~50-200 cycles
                                                             │
                                                    ┌────────▼─────────┐
                                                    │   AXI Interface  │
                                                    │                  │
                                                    │  Performance:    │
                                                    │  • Read BW       │
                                                    │  • Write BW      │
                                                    │  • Stalls        │
                                                    └────────┬─────────┘
                                                             │
                                                             │
                                                    ┌────────▼─────────┐
                                                    │  System Memory   │
                                                    │                  │
                                                    │  LPDDR4X         │
                                                    │  4/8 GB          │
                                                    │                  │
                                                    │  Bandwidth:      │
                                                    │  ~17 GB/s        │
                                                    │  (4266 MT/s)     │
                                                    └──────────────────┘

Latency 비교:
┌─────────────────────┬──────────────┬────────────────────────┐
│       위치           │   Latency    │         설명           │
├─────────────────────┼──────────────┼────────────────────────┤
│ RF (Register File)  │   0 cycles   │ 즉시 접근              │
│ Uniform FIFO        │   0 cycles   │ 즉시 접근 (sequential) │
│ L1 Texture Cache    │  ~5 cycles   │ TMU L1 hit             │
│ L2 Cache (L2T)      │ ~20 cycles   │ L2 hit                 │
│ System Memory       │ ~50-200      │ Cache miss             │
│                     │   cycles     │ (메모리 대역폭 영향)    │
└─────────────────────┴──────────────┴────────────────────────┘

Cache Coherency 주의사항:
⚠️  V3D는 하드웨어 캐시 일관성(cache coherency)을 제공하지 않음!
    • QPU 간 데이터 공유 시 명시적 flush 필요
    • Atomic 연산 사용 시 적절한 cache control 선택
    • CPU-GPU 간 데이터 공유 시 드라이버 레벨 동기화 필요
```

---

## 데이터 흐름

### 1. Compute Shader 실행 흐름

```
┌──────────────────────────────────────────────────────────────────────────┐
│               Compute Shader Dispatch (CSD) Flow                         │
└──────────────────────────────────────────────────────────────────────────┘

1. CPU: 커맨드 제출
   │
   ▼
┌────────────────────────────────────┐
│  CPU (ARM Cortex-A76)              │
│                                    │
│  1. Shader 컴파일                   │
│     NIR → VIR → QPU                │
│                                    │
│  2. BO (Buffer Object) 생성        │
│     • shader_bo: QPU 코드          │
│     • uniforms_bo: Uniform 데이터  │
│     • data_bo: 입출력 데이터        │
│                                    │
│  3. CSD 패킷 생성                   │
│     • Workgroup 크기               │
│     • Uniform 주소                 │
│     • Shader 주소                  │
│                                    │
│  4. DRM ioctl 호출                 │
│     DRM_IOCTL_V3D_SUBMIT_CSD       │
└─────────────┬──────────────────────┘
              │
              ▼ (via AXI bus)
┌─────────────────────────────────────┐
│  System Memory (DRAM)               │
│                                     │
│  ┌───────────────────────────────┐  │
│  │  Shader Code BO               │  │
│  │  [QPU instructions]           │  │
│  └───────────────────────────────┘  │
│                                     │
│  ┌───────────────────────────────┐  │
│  │  Uniforms BO                  │  │
│  │  [uniform[0], uniform[1], ...] │  │
│  └───────────────────────────────┘  │
│                                     │
│  ┌───────────────────────────────┐  │
│  │  Data BO (Input/Output)       │  │
│  │  [array data]                 │  │
│  └───────────────────────────────┘  │
└─────────────┬───────────────────────┘
              │
              ▼
┌──────────────────────────────────────────────────────────────┐
│  V3D Hub                                                     │
│                                                              │
│  ┌────────────────────────────────────────────────────────┐  │
│  │  CLE (Control List Executor)                          │  │
│  │                                                        │  │
│  │  1. CSD 패킷 파싱                                       │  │
│  │  2. Workgroup 분배                                     │  │
│  │     • Batch 크기 계산                                   │  │
│  │     • Supergroup 구성                                  │  │
│  │  3. QPU에 작업 할당                                     │  │
│  └────────────┬───────────────────────────────────────────┘  │
│               │                                              │
│  ┌────────────▼───────────────────────────────────────────┐  │
│  │  MMU (Memory Management Unit)                         │  │
│  │                                                        │  │
│  │  • 가상 주소 → 물리 주소 변환                            │  │
│  │  • 페이지 테이블 관리                                    │  │
│  └────────────────────────────────────────────────────────┘  │
└──────────────┬───────────────────────────────────────────────┘
               │
               ▼
┌──────────────────────────────────────────────────────────────┐
│  Slice 0 / Slice 1 / Slice 2 (병렬 실행)                      │
│                                                              │
│  ┌────────────────────────────────────────────────────────┐  │
│  │  QPU Execution (예: QPU 0)                             │  │
│  │                                                        │  │
│  │  Thread 0-15: 각각 독립적인 workgroup item 처리          │  │
│  │                                                        │  │
│  │  Phase 1: Setup                                       │  │
│  │    0: ldunifrf.rf0    ← Uniform FIFO에서 로드          │  │
│  │    1: ldunifrf.rf1                                    │  │
│  │    2: eidx rf7        ← Element ID (0-15)             │  │
│  │                                                        │  │
│  │  Phase 2: Computation                                 │  │
│  │    3-10: 산술 연산 (ADD/MUL ALU)                       │  │
│  │                                                        │  │
│  │  Phase 3: Memory Access (TMU)                         │  │
│  │    11: add rf39, rf0, rf7  ← 주소 계산                 │  │
│  │    12: shl rf39, rf39, 2   ← × 4 (word offset)        │  │
│  │    13: TMUA = rf39         ← TMU 주소 설정             │  │
│  │    14: TMUWT               ← TMU 대기                  │  │
│  │    15: ldtmu.rf40          ← TMU 결과 읽기             │  │
│  │         │                                              │  │
│  │         ├──► TMU Request ──┐                           │  │
│  │         │                  │                           │  │
│  │    16: thrsw               │ ← 쓰레드 전환 (지연 숨김)    │  │
│  │                            │                           │  │
│  └────────────────────────────┼────────────────────────────┘  │
│                               │                              │
│  ┌────────────────────────────▼────────────────────────────┐  │
│  │  TMU (Texture Memory Unit)                             │  │
│  │                                                        │  │
│  │  1. Request Queue에서 요청 처리                          │  │
│  │  2. L1 Cache 확인                                      │  │
│  │     ├─ Hit: 데이터 반환 (~5 cycles)                     │  │
│  │     └─ Miss: L2 요청                                   │  │
│  └────────────┬───────────────────────────────────────────┘  │
│               │                                              │
│               ▼ (on miss)                                    │
│         [L2 Cache]                                           │
│               │                                              │
│               ▼ (on L2 miss)                                 │
│         [System Memory via AXI]                              │
│               │                                              │
│               │                                              │
│  ┌────────────▼───────────────────────────────────────────┐  │
│  │  QPU Execution (continued)                             │  │
│  │                                                        │  │
│  │  Phase 4: Result Write                                │  │
│  │    17: add rf40, rf40, 1   ← 결과 계산                  │  │
│  │    18: TMUD = rf40         ← TMU 데이터 설정            │  │
│  │    19: TMUA = rf39         ← TMU 주소 (write)          │  │
│  │    20: TMUWT               ← TMU write 대기             │  │
│  │         │                                              │  │
│  │         └──► TMU Write ──► L1 ──► L2 ──► Memory       │  │
│  │                                                        │  │
│  │  Phase 5: Terminate                                   │  │
│  │    21: thrend              ← 쓰레드 종료                │  │
│  │    22: nop                                            │  │
│  │    23: nop                                            │  │
│  └────────────────────────────────────────────────────────┘  │
└──────────────────────────────────────────────────────────────┘
               │
               ▼
┌──────────────────────────────────────┐
│  V3D Hub                             │
│                                      │
│  1. 모든 QPU 완료 대기                 │
│  2. Interrupt 발생                   │
│     → DRM 커널 드라이버                │
└──────────────┬───────────────────────┘
               │
               ▼
┌──────────────────────────────────────┐
│  CPU                                 │
│                                      │
│  1. Interrupt 처리                   │
│  2. Syncobj 신호                     │
│  3. 사용자 프로그램 재개               │
│  4. 결과 데이터 읽기                  │
└──────────────────────────────────────┘
```

### 2. Tile-Based Rendering 흐름

```
┌──────────────────────────────────────────────────────────────────────────┐
│                    Tile-Based Deferred Rendering                         │
└──────────────────────────────────────────────────────────────────────────┘

                         1920×1080 화면
         ┌────────────────────────────────────────────┐
         │  ┌────┬────┬────┬────┬────┬────┬────┐      │
         │  │ T0 │ T1 │ T2 │ T3 │ T4 │ T5 │... │      │
         │  ├────┼────┼────┼────┼────┼────┼────┤      │
         │  │ T30│ T31│ T32│ T33│ T34│ T35│... │      │
         │  ├────┼────┼────┼────┼────┼────┼────┤      │
         │  │ T60│ T61│ T62│ T63│ T64│ T65│... │      │
         │  └────┴────┴────┴────┴────┴────┴────┘      │
         │                                            │
         │  각 타일: 64×64 픽셀                        │
         │  총 타일 수: 30 × 17 = 510 tiles           │
         └────────────────────────────────────────────┘

Phase A: Binning Pass (기하 처리)
┌──────────────────────────────────────────────────────────────┐
│  1. CPU: Binning Control List 제출                           │
│     • TILE_BINNING_MODE_CFG                                 │
│     • GL_SHADER_STATE (vertex shader)                       │
│     • Primitive list                                        │
└─────────────┬────────────────────────────────────────────────┘
              │
              ▼
┌──────────────────────────────────────────────────────────────┐
│  2. CLE: Binning 명령 실행                                    │
│                                                              │
│     각 프리미티브에 대해:                                       │
│     ┌──────────────────────────────────────────┐             │
│     │  a. Vertex Shader 실행 (QPU)             │             │
│     │     • 정점 위치 변환                      │             │
│     │     • Varyings 계산                      │             │
│     │     • VPM에 출력                          │             │
│     └──────────┬───────────────────────────────┘             │
│                │                                             │
│     ┌──────────▼───────────────────────────────┐             │
│     │  b. PTB (Primitive Tile Binner)          │             │
│     │     • 프리미티브가 어느 타일과 겹치는지 계산  │             │
│     │     • Tile Allocation Memory에 기록      │             │
│     └──────────┬───────────────────────────────┘             │
│                │                                             │
│                ▼                                             │
│     ┌─────────────────────────────────────────────────┐      │
│     │  Tile Allocation Memory (System Memory)        │      │
│     │                                                │      │
│     │  Tile 0: [prim 0, prim 5, prim 12, ...]        │      │
│     │  Tile 1: [prim 1, prim 3, prim 7, ...]         │      │
│     │  Tile 2: [prim 2, prim 8, prim 15, ...]        │      │
│     │  ...                                           │      │
│     └────────────────────────────────────────────────┘      │
└──────────────────────────────────────────────────────────────┘

Phase B: Rendering Pass (타일별 래스터화)
┌──────────────────────────────────────────────────────────────┐
│  3. CPU: Rendering Control List 제출                         │
│     • TILE_RENDERING_MODE_CFG_COMMON                        │
│     • For each tile: SUPERTILE_COORDINATES                  │
│     • GL_SHADER_STATE (fragment shader)                     │
└─────────────┬────────────────────────────────────────────────┘
              │
              ▼
┌──────────────────────────────────────────────────────────────┐
│  4. 각 타일에 대해 (순차 또는 병렬):                            │
│                                                              │
│     ┌────────────────────────────────────────────┐           │
│     │  a. TLB (Tile Buffer) 로드                 │           │
│     │     • On-chip 메모리 (16KB color + 16KB Z) │           │
│     │     • 이전 타일 데이터 (필요시)             │           │
│     └──────────┬─────────────────────────────────┘           │
│                │                                             │
│     ┌──────────▼─────────────────────────────────┐           │
│     │  b. 타일의 프리미티브 처리                   │           │
│     │                                            │           │
│     │     For each primitive in tile:           │           │
│     │     ┌────────────────────────────────┐     │           │
│     │     │  i. PSE (Primitive Setup)      │     │           │
│     │     │     • Edge equations           │     │           │
│     │     │     • Barycentric coords       │     │           │
│     │     └──────────┬─────────────────────┘     │           │
│     │                │                           │           │
│     │     ┌──────────▼─────────────────────┐     │           │
│     │     │  ii. Fragment Shader (QPU)     │     │           │
│     │     │      • Varyings 보간            │     │           │
│     │     │      • Texture sampling (TMU)  │     │           │
│     │     │      • 색상 계산                 │     │           │
│     │     └──────────┬─────────────────────┘     │           │
│     │                │                           │           │
│     │     ┌──────────▼─────────────────────┐     │           │
│     │     │  iii. TLB Operations           │     │           │
│     │     │       • Depth test             │     │           │
│     │     │       • Stencil test           │     │           │
│     │     │       • Blending               │     │           │
│     │     │       • TLB에 쓰기              │     │           │
│     │     └────────────────────────────────┘     │           │
│     └────────────────────────────────────────────┘           │
│                │                                             │
│     ┌──────────▼─────────────────────────────────┐           │
│     │  c. TLB Writeback                          │           │
│     │     • TLB → L2 Cache → System Memory       │           │
│     │     • Framebuffer에 타일 데이터 저장         │           │
│     └────────────────────────────────────────────┘           │
│                                                              │
│  5. 모든 타일 완료 → 렌더링 종료                               │
└──────────────────────────────────────────────────────────────┘

TBDR의 장점:
✓ 대역폭 절감: TLB가 on-chip이므로 메모리 접근 최소화
✓ 오버드로우 최적화: Early-Z로 불필요한 fragment shader 실행 방지
✓ 타일 단위 병렬성: 여러 타일을 동시에 처리 가능
```

---

## 성능 특성

### 1. 이론적 성능

```
┌─────────────────────────────────────────────────────────────────┐
│            Raspberry Pi 5 V3D 7.1 이론 성능                      │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  GPU 클럭: ~800 MHz (추정, 정확한 값은 펌웨어에 따라 다름)          │
│                                                                 │
│  ┌──────────────────────────────────────────────────────────┐   │
│  │  연산 성능 (Floating Point)                              │   │
│  ├──────────────────────────────────────────────────────────┤   │
│  │                                                          │   │
│  │  QPU당 성능:                                              │   │
│  │  • ADD ALU: 16 ops/cycle (16-way SIMD)                  │   │
│  │  • MUL ALU: 16 ops/cycle (16-way SIMD)                  │   │
│  │  • Dual Issue: 32 FLOPs/cycle (ADD + MUL 동시)          │   │
│  │                                                          │   │
│  │  총 QPU 개수: 12                                          │   │
│  │                                                          │   │
│  │  Peak Performance:                                       │   │
│  │  = 12 QPU × 32 FLOPs/cycle × 800 MHz                    │   │
│  │  = 307.2 GFLOPS                                         │   │
│  │  ≈ 0.3 TFLOPS                                           │   │
│  │                                                          │   │
│  └──────────────────────────────────────────────────────────┘   │
│                                                                 │
│  ┌──────────────────────────────────────────────────────────┐   │
│  │  메모리 대역폭                                             │   │
│  ├──────────────────────────────────────────────────────────┤   │
│  │                                                          │   │
│  │  LPDDR4X: 4266 MT/s × 32-bit                            │   │
│  │                                                          │   │
│  │  Theoretical Bandwidth:                                  │   │
│  │  = 4266 MHz × 4 bytes = 17.064 GB/s                     │   │
│  │  ≈ 17 GB/s                                              │   │
│  │                                                          │   │
│  │  실제 달성 가능: ~80% ≈ 13.6 GB/s                         │   │
│  │  (AXI overhead, refresh, etc.)                          │   │
│  │                                                          │   │
│  └──────────────────────────────────────────────────────────┘   │
│                                                                 │
│  ┌──────────────────────────────────────────────────────────┐   │
│  │  텍스처 성능                                               │   │
│  ├──────────────────────────────────────────────────────────┤   │
│  │                                                          │   │
│  │  TMU당 성능: ~1 bilinear sample/cycle (추정)              │   │
│  │  총 TMU 개수: 3 (Slice당 1개, 추정)                        │   │
│  │                                                          │   │
│  │  Peak Texel Rate:                                        │   │
│  │  = 3 TMU × 1 sample/cycle × 800 MHz                     │   │
│  │  = 2.4 GTexels/s                                        │   │
│  │                                                          │   │
│  └──────────────────────────────────────────────────────────┘   │
│                                                                 │
│  ┌──────────────────────────────────────────────────────────┐   │
│  │  필 레이트 (Fill Rate)                                     │   │
│  ├──────────────────────────────────────────────────────────┤   │
│  │                                                          │   │
│  │  TLB 처리량: Slice당 독립적으로 타일 처리                    │   │
│  │                                                          │   │
│  │  • 64×64 tile = 4096 pixels/tile                        │   │
│  │  • ~수백 cycles/tile (셰이더 복잡도 의존)                   │   │
│  │                                                          │   │
│  │  단순 색상 쓰기 기준:                                       │   │
│  │  ≈ 1-2 GPixels/s (추정)                                  │   │
│  │                                                          │   │
│  └──────────────────────────────────────────────────────────┘   │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

### 2. 성능 병목 요인

```
┌─────────────────────────────────────────────────────────────────┐
│                      Performance Bottlenecks                    │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  1. 메모리 대역폭 (Memory Bandwidth)                             │
│     ┌────────────────────────────────────────────────────┐      │
│     │  • 가장 흔한 병목                                    │      │
│     │  • TMU cache miss 시 L2 → DRAM 접근                 │      │
│     │  • 랜덤 메모리 접근 패턴                              │      │
│     │                                                    │      │
│     │  완화 방법:                                         │      │
│     │  ✓ Sequential access (spatial locality)           │      │
│     │  ✓ 256-byte alignment                             │      │
│     │  ✓ Texture compression (BSTC)                     │      │
│     │  ✓ Shared memory 활용                              │      │
│     └────────────────────────────────────────────────────┘      │
│                                                                 │
│  2. TMU 지연 (TMU Latency)                                      │
│     ┌────────────────────────────────────────────────────┐      │
│     │  • L1 cache miss: ~20 cycles (L2)                  │      │
│     │  • L2 cache miss: ~50-200 cycles (DRAM)            │      │
│     │  • ldtmu 대기: 최대 16개 pending                     │      │
│     │                                                    │      │
│     │  완화 방법:                                         │      │
│     │  ✓ thrsw로 쓰레드 전환 (latency hiding)              │      │
│     │  ✓ TMU 요청과 계산 인터리브                          │      │
│     │  ✓ Prefetch 활용                                   │      │
│     └────────────────────────────────────────────────────┘      │
│                                                                 │
│  3. QPU 활용률 (QPU Utilization)                                │
│     ┌────────────────────────────────────────────────────┐      │
│     │  • 불균형 workgroup 분배                            │      │
│     │  • Branch divergence (SIMD 비효율)                 │      │
│     │  • Insufficient parallelism                       │      │
│     │                                                    │      │
│     │  완화 방법:                                         │      │
│     │  ✓ Workgroup size 조정 (16의 배수 선호)             │      │
│     │  ✓ Branch 최소화                                   │      │
│     │  ✓ Occupancy 최대화 (192 threads 목표)             │      │
│     └────────────────────────────────────────────────────┘      │
│                                                                 │
│  4. 레지스터 압력 (Register Pressure)                            │
│     ┌────────────────────────────────────────────────────┐      │
│     │  • rf0~rf63: 64개 레지스터                          │      │
│     │  • 과다 사용 시 spill → TMU 사용 → 지연              │      │
│     │                                                    │      │
│     │  완화 방법:                                         │      │
│     │  ✓ 레지스터 재사용                                   │      │
│     │  ✓ Live range 최소화                               │      │
│     │  ✓ 컴파일러 최적화 활용                              │      │
│     └────────────────────────────────────────────────────┘      │
│                                                                 │
│  5. AXI Bus 경합 (AXI Contention)                               │
│     ┌────────────────────────────────────────────────────┐      │
│     │  • CPU와 GPU가 AXI 공유                             │      │
│     │  • 다른 I/O 장치 (PCIe, USB, etc.)                  │      │
│     │                                                    │      │
│     │  완화 방법:                                         │      │
│     │  ✓ CPU-GPU 동기화 최소화                            │      │
│     │  ✓ DMA 전송 시간 분산                               │      │
│     │  ✓ I/O 부하 관리                                    │      │
│     └────────────────────────────────────────────────────┘      │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

### 3. Performance Counters

Mesa 코드에서 추출한 주요 성능 카운터:

```
┌─────────────────────────────────────────────────────────────────┐
│                    V3D Performance Counters                     │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  QPU 카운터:                                                     │
│  • QPU-idle-cycles: QPU 유휴 사이클                              │
│  • QPU-active-cycles-vertex: 버텍스 셰이더 활성 사이클             │
│  • QPU-active-cycles-fragment: 프래그먼트 셰이더 활성 사이클        │
│  • QPU-cycles-valid-instr: 유효 명령어 실행 사이클                 │
│  • QPU-cycles-TMU-stall: TMU 대기 사이클                         │
│  • QPU-cycles-scoreboard-stall: Scoreboard 대기                 │
│  • QPU-cycles-varyings-stall: Varyings 대기                     │
│  • QPU-ic-hit/miss: Instruction cache hit/miss                │
│  • QPU-uc-hit/miss: Uniform cache hit/miss                    │
│                                                                 │
│  TMU 카운터:                                                     │
│  • TMU-tcache-access: L1 texture cache 접근                     │
│  • TMU-tcache-miss: L1 texture cache miss                      │
│  • TMU-active-cycles: TMU 활성 사이클                            │
│  • TMU-stalled-cycles: TMU 지연 사이클                           │
│  • TMU-config-accesses: TMU configuration 접근                  │
│                                                                 │
│  L2 Cache (L2T) 카운터:                                          │
│  • L2T-hits: L2 cache hit                                      │
│  • L2T-misses: L2 cache miss                                   │
│  • L2T-TMU-reads: TMU L2 읽기                                   │
│  • L2T-TMU-writes: TMU L2 쓰기                                  │
│  • L2T-TMU-read-misses: TMU L2 read miss                       │
│  • L2T-TMU-write-misses: TMU L2 write miss                     │
│  • L2T-memory-reads: L2에서 메모리 읽기                           │
│  • L2T-memory-writes: L2에서 메모리 쓰기                          │
│  • L2T-stalls-mem: AXI 블록으로 인한 지연                         │
│  • L2T-SLC-read-hits: Slice별 L2 read hit (all slices)         │
│  • L2T-SLC-read-miss: Slice별 L2 read miss (all slices)        │
│                                                                 │
│  AXI 카운터:                                                     │
│  • AXI-writes-seen-watch-0/1: AXI 쓰기 트랜잭션                   │
│  • AXI-reads-seen-watch-0/1: AXI 읽기 트랜잭션                    │
│  • AXI-writes-stalled-seen-watch-0/1: AXI 쓰기 지연               │
│  • AXI-reads-stalled-seen-watch-0/1: AXI 읽기 지연                │
│  • AXI-write-bytes-seen-watch-0/1: 총 쓰기 바이트                 │
│  • AXI-read-bytes-seen-watch-0/1: 총 읽기 바이트                  │
│  • AXI-read-trans: 읽기 트랜잭션 수                               │
│  • AXI-write-trans: 쓰기 트랜잭션 수                              │
│  • AXI-read-wait-cycles: 읽기 대기 사이클                         │
│  • AXI-write-wait-cycles: 쓰기 대기 사이클                        │
│                                                                 │
│  TLB 카운터:                                                     │
│  • TLB-quads-stencil-fail: 스텐실 테스트 실패 quad               │
│  • TLB-quads-stencilz-fail: 스텐실+depth 실패 quad              │
│  • TLB-quads-stencilz-pass: 스텐실+depth 통과 quad              │
│  • TLB-quads-zero-coverage: 0 커버리지 quad                      │
│  • TLB-quads-nonzero-coverage: 비0 커버리지 quad                 │
│  • TLB-quads-written: TLB에 쓰인 quad                           │
│  • TLB-memory-reads: TLB 메모리 읽기                             │
│  • TLB-memory-writes: TLB 메모리 쓰기                            │
│                                                                 │
│  기타 카운터:                                                     │
│  • PTB-primitives-binned: 비닝된 프리미티브 수                     │
│  • CLE-active: CLE 활성 시간                                     │
│  • Bin-active: 비닝 패스 활성 시간                                │
│  • Render-active: 렌더링 패스 활성 시간                           │
│  • Compute-active: Compute 셰이더 활성 시간                       │
│  • Cycle-count: 총 사이클 수                                     │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘

사용 방법 (DRM API):
1. DRM_IOCTL_V3D_PERFMON_CREATE: 카운터 세트 생성
2. Job 제출 시 perfmon_id 지정
3. DRM_IOCTL_V3D_PERFMON_GET_VALUES: 결과 읽기
```

---

## 하드웨어 식별 정보

### IDENT 레지스터

Mesa 코드(`v3d_device_info.c`)에서 하드웨어 정보를 읽는 방법:

```c
// IDENT0: GPU 버전
uint32_t major = (ident0.value >> 24) & 0xff;  // V3D major version
// Raspberry Pi 5: major = 7

// IDENT1: QPU 구성
uint32_t minor = (ident1.value >> 0) & 0xf;    // V3D minor version (1)
uint32_t nslc = (ident1.value >> 4) & 0xf;     // Number of slices (3)
uint32_t qups = (ident1.value >> 8) & 0xf;     // QPUs per slice (4)
uint32_t vpm_size_multiplier = (ident1.value >> 28) & 0xf;
uint32_t vpm_size = vpm_size_multiplier * 8192; // VPM 크기

devinfo->ver = major * 10 + minor;  // 71
devinfo->qpu_count = nslc * qups;   // 3 × 4 = 12

// HUB_IDENT3: 리비전 정보
devinfo->rev = (hub_ident3.value >> 8) & 0xff;
devinfo->compat_rev = (hub_ident3.value >> 16) & 0xff;
```

**Raspberry Pi 5 실제 값:**
- V3D version: 7.1 (V3D 71)
- NSLC: 3 (3 slices)
- QUPS: 4 (4 QPUs per slice)
- Total QPUs: 12
- Revision: 2, 5, 10 등 (펌웨어/하드웨어 버전에 따라 다름)

---

## 참고 자료

### Mesa 코드 주요 파일

1. **Device Info**: [medusa/broadcom/common/v3d_device_info.c](medusa/broadcom/common/v3d_device_info.c:70-72)
   - IDENT 레지스터 파싱
   - QPU 개수 계산: `qpu_count = NSLC × QUPS`

2. **Performance Counters**: [medusa/broadcom/common/v3d_performance_counters.h](medusa/broadcom/common/v3d_performance_counters.h)
   - V3D 4.2와 7.1의 성능 카운터 정의
   - AXI, L2T, TMU, QPU 등 카운터

3. **CLE Packets**: [medusa/broadcom/cle/v3d_packet_v71_pack.h](medusa/broadcom/cle/v3d_packet_v71_pack.h)
   - V3D 7.1 Control List 패킷 정의
   - Binning, Rendering, Compute 명령어

4. **QPU Instructions**: [medusa/broadcom/qpu/qpu_instr.h](medusa/broadcom/qpu/qpu_instr.h)
   - QPU 명령어 구조체
   - ADD/MUL ALU, TMU, 레지스터 정의

5. **TMU Cache**: [medusa/broadcom/qpu/TMU_CACHE_ARCHITECTURE.md](medusa/broadcom/qpu/TMU_CACHE_ARCHITECTURE.md)
   - TMU 캐시 계층 구조
   - Atomic 연산과 캐시 제어

6. **TLB Configuration**: [medusa/broadcom/common/v3d_util.c](medusa/broadcom/common/v3d_util.c:90-108)
   - V3D 7.1 TLB 크기: 16 KB (color), 16 KB (depth), 8 KB (aux depth)
   - 타일 크기 선택 로직

### 관련 문서

- [CLE (Control List Executor) README](medusa/broadcom/cle/README.md)
- [TMU Cache Architecture](medusa/broadcom/qpu/TMU_CACHE_ARCHITECTURE.md)
- [QPU Hardware Analysis](medusa/sample/v3d/sample1/QPU_HARDWARE_ANALYSIS.md)
- [Why 16 Threads per QPU](medusa/broadcom/qpu/WHY_16_THREADS_PER_QPU.md)

### 외부 참고 자료

- Broadcom VideoCore Documentation (NDA)
- Mesa V3D Driver Source Code
- Raspberry Pi 5 BCM2712 Datasheet (공식 미공개)

---

## 요약

Raspberry Pi 5의 V3D 7.1 GPU는 다음과 같은 구조로 이루어져 있습니다:

1. **3개 Slice**, 각 Slice는 **4개 QPU**와 **1개 TMU**(추정)를 포함
2. **총 12개 QPU**, 각 QPU는 **16-way SIMD**로 동시에 16개 쓰레드 실행
3. **2단계 캐시**: TMU L1 (~16 KB/Slice) → L2 (~128 KB, 공유)
4. **AXI 버스**를 통해 **LPDDR4X 시스템 메모리** 접근 (~17 GB/s 이론 대역폭)
5. **Tile-Based Rendering**: 64×64 픽셀 타일 단위로 on-chip 메모리(TLB) 활용
6. **이론 성능**: ~0.3 TFLOPS (FP32), 2.4 GTexels/s (추정)

주요 특징:
- ✓ Cooperative Multithreading (thrsw)으로 메모리 지연 숨김
- ✓ Dual Issue (ADD + MUL 동시 실행)
- ✓ 하드웨어 캐시 일관성 없음 (명시적 flush 필요)
- ✓ Atomic 연산으로 캐시 제어 가능
- ✓ 성능 카운터로 세밀한 프로파일링 가능
